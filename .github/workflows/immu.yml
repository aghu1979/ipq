# ==============================================================================
# ImmortalWrt è‡ªåŠ¨åŒ–ç¼–è¯‘å·¥ä½œæµ
#
# åŠŸèƒ½:
#   1. è‡ªåŠ¨åŒ–ç¼–è¯‘ ImmortalWrt å›ºä»¶ï¼Œæ”¯æŒå¤šè®¾å¤‡
#   2. é›†æˆç£ç›˜ç©ºé—´æ‰©å±•ã€é«˜çº§ç¼“å­˜ç­–ç•¥
#   3. ç”Ÿæˆ LuCI è½¯ä»¶åŒ…å·®å¼‚æŠ¥å‘Šå’Œè®¾å¤‡æ¸…å•
#   4. æä¾›ä¼ä¸šçº§çš„æ—¥å¿—ã€é”™è¯¯æ§åˆ¶å’Œå‘å¸ƒç³»ç»Ÿ
#
# è§¦å‘æ–¹å¼:
#   - æ‰‹åŠ¨è§¦å‘
#   - å®šæ—¶è§¦å‘ (å·²æ³¨é‡Šï¼Œå¯æŒ‰éœ€å¯ç”¨)
#
# ä½œè€…: Mary
# æ—¥æœŸï¼š20251201
# ç‰ˆæœ¬: 2.6 - å†…è” diy.sh å‘½ä»¤ä»¥ç»•è¿‡è¯­æ³•é”™è¯¯
# ==============================================================================

name: ImmortalWrt è‡ªåŠ¨ç¼–è¯‘ç³»ç»Ÿ

on:
  workflow_dispatch:
    inputs:
      upload_bin_dir:
        description: 'æ˜¯å¦ä¸Šä¼ æ•´ä¸ª bin ç›®å½• (è°ƒè¯•ç”¨)'
        required: false
        default: 'false'
        type: boolean
  # schedule:
  #   - cron: 0 20 * * 4 # æ¯å‘¨å›› UTC20:00 è‡ªåŠ¨ç¼–è¯‘

env:
  REPO_URL: https://github.com/laipeng668/immortalwrt.git
  REPO_BRANCH: master
  CONFIG_FILE: configs/immu.config
  DIY_SCRIPT: scripts/diy.sh
  EXTEND_DISK_SCRIPT: scripts/extend_disk.sh
  FIRMWARE_RELEASE: true
  FIRMWARE_TAG: immu
  TZ: Asia/Shanghai

jobs:
  Build:
    runs-on: ubuntu-24.04

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        # --- æ—¥å¿—å’Œé¢œè‰²å‡½æ•°å®šä¹‰ ---
        export TERM=xterm-256color
        log_info() { echo -e "\033[34m[INFO]\033[0m $1"; }
        log_success() { echo -e "\033[32m[OK]\033[0m $1"; }
        log_warn() { echo -e "\033[33m[WARN]\033[0m $1"; }
        log_error() { echo -e "\033[31m[FAIL]\033[0m $1"; }

        log_info "åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ..."
        sudo -E apt-get -qq update

        # --- é˜¶æ®µä¸€ï¼šå®‰è£…æ ¸å¿ƒä¾èµ–ï¼Œç¡®ä¿åŸºç¡€ç¯å¢ƒå¯ç”¨ ---
        log_info "å®‰è£…æ ¸å¿ƒç¼–è¯‘ä¾èµ–..."
        # ä¿®å¤ï¼šç§»é™¤åœ¨ Ubuntu 24.04 ä¸­å·²å¼ƒç”¨çš„ python3-distutils å’Œ python3-setuptools
        # æ–°å¢ï¼šæ·»åŠ  jq ä¾èµ–ä»¥æ”¯æŒè‡ªåŠ¨æŒ‚è½½åŠŸèƒ½
        CORE_DEPS="build-essential libncurses5-dev libncursesw5-dev zlib1g-dev gawk git gettext libssl-dev xsltproc wget unzip python3 python3-pip python3-wheel rsync jq"
        sudo -E apt-get -qq install -y $CORE_DEPS
        log_success "æ ¸å¿ƒä¾èµ–å®‰è£…å®Œæˆ"

        # --- é˜¶æ®µäºŒï¼šå°è¯•ä»ç¤¾åŒºæºè¡¥å……ä¾èµ–ï¼Œå®ç°ä¼˜é›…é™çº§ ---
        log_info "å°è¯•ä»ç¤¾åŒºæº (ophub.org) è¡¥å……ä¾èµ–..."
        ADDITIONAL_DEPS_URL="https://ophub.org/ubuntu2404-make-openwrt-depends"
        ADDITIONAL_DEPS=$(curl -fsSL "$ADDITIONAL_DEPS_URL" 2>/dev/null || echo "")

        if [ -n "$ADDITIONAL_DEPS" ]; then
          log_success "æˆåŠŸè·å–è¡¥å……ä¾èµ–åˆ—è¡¨"
          sudo -E apt-get -qq install -y $ADDITIONAL_DEPS || log_warn "éƒ¨åˆ†è¡¥å……ä¾èµ–å®‰è£…å¤±è´¥ï¼Œä½†æ ¸å¿ƒä¾èµ–å·²æ»¡è¶³ï¼Œæ„å»ºå¯ç»§ç»­"
        else
          log_warn "æ— æ³•ä» $ADDITIONAL_DEPS_URL è·å–è¡¥å……ä¾èµ–åˆ—è¡¨ (å¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–æœåŠ¡ä¸å¯ç”¨)ã€‚"
          log_warn "æ„å»ºå°†ç»§ç»­ï¼Œä½†å¯èƒ½ç¼ºå°‘æŸäº›éæ ¸å¿ƒå·¥å…·ã€‚"
        fi

        sudo -E systemctl daemon-reload
        sudo timedatectl set-timezone "$TZ"
        log_success "ç¼–è¯‘ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

    - name: æ£€å‡ºæºç 
      id: checkout
      run: |
        # --- æ—¥å¿—å’Œé¢œè‰²å‡½æ•°å®šä¹‰ ---
        export TERM=xterm-256color
        log_info() { echo -e "\033[34m[INFO]\033[0m $1"; }
        log_success() { echo -e "\033[32m[OK]\033[0m $1"; }
        log_warn() { echo -e "\033[33m[WARN]\033[0m $1"; }
        log_error() { echo -e "\033[31m[FAIL]\033[0m $1"; }

        log_info "æ£€å‡º ImmortalWrt æºç ..."
        df -hT $GITHUB_WORKSPACE
        sudo mkdir -p /mnt/openwrt
        sudo chown -R $(id -u):$(id -g) /mnt/openwrt
        git clone --depth 1 -b $REPO_BRANCH --single-branch $REPO_URL /mnt/openwrt
        cd /mnt/openwrt
        
        # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "OPENWRT_PATH=/mnt/openwrt" >> $GITHUB_ENV
        VERSION_INFO=$(git show -s --date=short --format="ä½œè€…: %an<br/>æ—¶é—´: %cd<br/>å†…å®¹: %s<br/>Hash: %H")
        echo "VERSION_INFO=$VERSION_INFO" >> $GITHUB_ENV
        echo "CACHE_DATE=$(date +"%Y-%m-%d-%H%M%S")" >> $GITHUB_ENV
        log_success "æºç æ£€å‡ºå®Œæˆ"

    - name: æ‰©å±•ç£ç›˜ç©ºé—´ (å…³é”®æ­¥éª¤)
      run: |
        # --- æ—¥å¿—å’Œé¢œè‰²å‡½æ•°å®šä¹‰ ---
        export TERM=xterm-256color
        log_info() { echo -e "\033[34m[INFO]\033[0m $1"; }
        log_success() { echo -e "\033[32m[OK]\033[0m $1"; }
        log_warn() { echo -e "\033[33m[WARN]\033[0m $1"; }
        log_error() { echo -e "\033[31m[FAIL]\033[0m $1"; }

        log_info "å‡†å¤‡æ‰©å±•ç£ç›˜ç©ºé—´..."
        if [ -f "${{ github.workspace }}/${{ env.EXTEND_DISK_SCRIPT }}" ]; then
          chmod +x "${{ github.workspace }}/${{ env.EXTEND_DISK_SCRIPT }}"
          # åœ¨æºç ç›®å½•å†…æ‰§è¡Œï¼Œå› ä¸ºè„šæœ¬ä¼šå¤„ç†å½“å‰ç›®å½•ä¸‹çš„å­ç›®å½•
          cd ${{ env.OPENWRT_PATH }}
          ${{ github.workspace }}/${{ env.EXTEND_DISK_SCRIPT }} .
          log_success "ç£ç›˜ç©ºé—´æ‰©å±•å®Œæˆ"
        else
          log_warn "æœªæ‰¾åˆ°ç£ç›˜æ‰©å±•è„šæœ¬ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
        fi

    - name: ç¼“å­˜å·¥å…·é“¾å’Œä¸‹è½½ç›®å½• (å…³é”®æ­¥éª¤)
      uses: actions/cache@v4
      with:
        path: |
          ${{ env.OPENWRT_PATH }}/.ccache
          ${{ env.OPENWRT_PATH }}/dl
          ${{ env.OPENWRT_PATH }}/staging_dir
        key: ${{ env.REPO_BRANCH }}-${{ hashFiles('configs/immu.config') }}-${{ env.CACHE_DATE }}
        restore-keys: |
          ${{ env.REPO_BRANCH }}-${{ hashFiles('configs/immu.config') }}-

    - name: åŠ è½½è‡ªå®šä¹‰é…ç½®ä¸ç”ŸæˆæŠ¥å‘Š (å†…è”å‘½ä»¤ç‰ˆ)
      id: config
      run: |
        # --- æ—¥å¿—å’Œé¢œè‰²å‡½æ•°å®šä¹‰ ---
        export TERM=xterm-256color
        log_info() { echo -e "\033[34m[INFO]\033[0m $1"; }
        log_success() { echo -e "\033[32m[OK]\033[0m $1"; }
        log_warn() { echo -e "\033[33m[WARN]\033[0m $1"; }
        log_error() { echo -e "\033[31m[FAIL]\033[0m $1"; }
        
        cd ${{ env.OPENWRT_PATH }}
        CONFIG_PATH="${{ github.workspace }}/${{ env.CONFIG_FILE }}"
        
        # 1. æå–è®¾å¤‡åç§°
        log_info "ä»é…ç½®æ–‡ä»¶ä¸­æå–ç›®æ ‡è®¾å¤‡..."
        DEVICES=$(grep "^CONFIG_TARGET_DEVICE_.*_DEVICE_.*=y" "$CONFIG_PATH" | sed 's/^CONFIG_TARGET_DEVICE_.*_DEVICE_\(.*\)=y/\1/' | sort -u | tr '\n' ' ')
        echo "DEVICE_LIST=$DEVICES" >> $GITHUB_ENV
        log_success "æå–åˆ°è®¾å¤‡: $DEVICES"

        # 2. ç”Ÿæˆ LuCI åŒ…å·®å¼‚æŠ¥å‘Š
        log_info "å‡†å¤‡ç”Ÿæˆ LuCI åŒ…å·®å¼‚æŠ¥å‘Š..."
        
        # åˆå§‹åŒ…åˆ—è¡¨
        grep "^CONFIG_PACKAGE_luci-app-.*=y" "$CONFIG_PATH" | sed 's/CONFIG_PACKAGE_\(.*\)=y/\1/' | sort > initial_luci.txt
        
        # 3. æ‰§è¡Œ diy.sh çš„æ‰€æœ‰å‘½ä»¤ (å†…è”ç‰ˆæœ¬)
        log_info "æ‰§è¡Œ diy.sh å‡†å¤‡è½¯ä»¶æº (å†…è”ç‰ˆæœ¬)..."
        
        # --- ä¿®æ”¹åŸºæœ¬é…ç½® ---
        log_info "ä¿®æ”¹åŸºæœ¬é…ç½® (IPã€ä¸»æœºåã€å¯†ç )..."
        sed -i "s/192.168.1.1/192.168.111.1/g" package/base-files/files/bin/config_generate
        sed -i "s/hostname='.*'/hostname='WRT'/g" package/base-files/files/bin/config_generate
        log_info "è®¾ç½®åˆå§‹ç™»å½•å¯†ç ä¸ºç©º..."
        shadow_file="package/base-files/files/etc/shadow"
        if [ -f "$shadow_file" ]; then sed -i 's/^root:[^:]*:/root::/' "$shadow_file"; fi
        log_success "åŸºæœ¬é…ç½®ä¿®æ”¹å®Œæˆ"
        
        # --- æ·»åŠ  feeds ---
        log_info "æ·»åŠ  feeds..."
        echo "src-git passwall_packages https://github.com/xiaorouji/openwrt-passwall-packages.git;main" >> "feeds.conf.default"
        echo "src-git passwall_luci https://github.com/xiaorouji/openwrt-passwall.git;main" >> "feeds.conf.default"
        echo "src-git passwall2 https://github.com/xiaorouji/openwrt-passwall2.git;main" >> "feeds.conf.default"
        echo "src-git luci-app-openclash https://github.com/vernesong/OpenClash.git" >> "feeds.conf.default"
        echo "src-git momo https://github.com/nikkinikki-org/OpenWrt-momo;main" >> "feeds.conf.default"
        echo "src-git nikki https://github.com/nikkinikki-org/OpenWrt-nikki;main" >> "feeds.conf.default"
        log_success "Feeds æ·»åŠ å®Œæˆ"

        # --- å…‹éš†è½¯ä»¶åŒ… ---
        log_info "å…‹éš†è½¯ä»¶åŒ…..."
        git clone "https://github.com/VIKINGYFY/homeproxy" package/homeproxy
        git clone "https://github.com/sirpdboy/luci-app-adguardhome" package/luci-app-adguardhome
        git clone "https://github.com/sirpdboy/luci-app-ddns-go" package/luci-app-ddns-go"
        git clone "https://github.com/gdy666/luci-app-lucky" package/luci-app-lucky
        git clone "https://github.com/EasyTier/luci-app-easytier" package/luci-app-easytier
        git clone "https://github.com/lwb1978/openwrt-gecoosac" package/openwrt-gecoosac"
        git clone "https://github.com/sirpdboy/luci-app-netdata" package/luci-app-netdata
        git clone "https://github.com/sirpdboy/luci-app-netspeedtest" package/luci-app-netspeedtest
        git clone "https://github.com/sirpdboy/luci-app-partexp" package/luci-app-partexp
        git clone "https://github.com/sirpdboy/luci-app-taskplan" package/luci-app-taskplan
        git clone "https://github.com/sbwml/luci-app-quickfile" package/luci-app-quickfile
        git clone "https://github.com/tty228/luci-app-wechatpush" package/luci-app-wechatpush
        git clone "https://github.com/destan19/OpenAppFilter" package/luci-app-oaf"
        git clone "https://github.com/jerrykuku/luci-theme-argon" feeds/luci/themes/luci-theme-argon
        git clone "https://github.com/eamonxg/luci-theme-aurora" feeds/luci/themes/luci-theme-aurora
        git clone -b "v5" "https://github.com/sbwml/luci-app-mosdns" package/luci-app-mosdns
        git clone "https://github.com/sbwml/luci-app-openlist2" package/luci-app-openlist2
        git clone -b "25.x" "https://github.com/sbwml/packages_lang_golang" feeds/packages/lang/golang"
        git clone "https://github.com/NONGFAH/luci-app-athena-led" package/luci-app-athena-led
        chmod +x package/luci-app-athena-led/root/etc/init.d/athena_led package/luci-app-athena-led/root/usr/sbin/athena-led
        git clone "https://github.com/asvow/luci-app-tailscale" package/luci-app-tailscale
        git clone "https://github.com/lmq8267/luci-app-vnt" package/luci-app-vnt
        git clone "https://github.com/kenzok8/small-package" small
        log_success "è½¯ä»¶åŒ…å…‹éš†å®Œæˆ"
        
        # --- ç¨€ç–å…‹éš† ---
        log_info "ç¨€ç–å…‹éš†ç‰¹æ®Šè½¯ä»¶åŒ…..."
        git clone --depth=1 -b "ariang" --single-branch --filter=blob:none --sparse "https://github.com/laipeng668/packages"
        cd packages && git sparse-checkout set net/ariang && mv -f net/ariang ../package && cd .. && rm -rf packages
        git clone --depth=1 -b "frp" --single-branch --filter=blob:none --sparse "https://github.com/laipeng668/packages"
        cd packages && git sparse-checkout set net/frp && mv -f net/frp ../package && cd .. && rm -rf packages
        mkdir -p feeds/packages/net && mv -f package/frp feeds/packages/net/frp
        git clone --depth=1 -b "frp" --single-branch --filter=blob:none --sparse "https://github.com/laipeng668/luci"
        cd luci && git sparse-checkout set applications/luci-app-frpc applications/luci-app-frps && mv -f applications/luci-app-frpc ../package && mv -f applications/luci-app-frps ../package && cd .. && rm -rf luci
        mkdir -p feeds/luci/applications && mv -f package/luci-app-frpc feeds/luci/applications/luci-app-frpc && mv -f package/luci-app-frps feeds/luci/applications/luci-app-frps
        git clone --depth=1 -b "main" --single-branch --filter=blob:none --sparse "https://github.com/VIKINGYFY/packages"
        cd packages && git sparse-checkout set luci-app-wolplus && mv -f luci-app-wolplus ../package && cd .. && rm -rf packages
        log_success "ç¨€ç–å…‹éš†å®Œæˆ"

        # --- æ›´æ–° feeds ---
        log_info "æ›´æ–° feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        log_success "Feeds æ›´æ–°å®Œæˆ"

        # --- ä¿®æ”¹ Feeds ä¸­çš„åŒ… ---
        log_info "ä¿®æ”¹ Feeds ä¸­çš„åŒ…..."
        tailscale_makefile="feeds/packages/net/tailscale/Makefile"
        if [ -f "$tailscale_makefile" ]; then
            sed -i '/\/etc\/init\.d\/tailscale/d;/\/etc\/config\/tailscale/d;' "$tailscale_makefile"
        fi
        log_success "Feeds åŒ…ä¿®æ”¹å®Œæˆ"
        
        # --- ç§»é™¤å†²çªçš„é»˜è®¤åŒ… ---
        log_info "ç§»é™¤å†²çªçš„é»˜è®¤åŒ…..."
        sed -i "/attendedsysupgrade/d" $(find ./feeds/luci/collections/ -type f -name "Makefile" 2>/dev/null)
        rm -rf feeds/luci/applications/luci-app-wechatpush
        rm -rf feeds/luci/applications/luci-app-appfilter
        rm -rf feeds/luci/applications/luci-app-frpc
        rm -rf feeds/luci/applications/luci-app-frps
        rm -rf feeds/luci/themes/luci-theme-argon
        rm -rf feeds/packages/net/open-app-filter
        rm -rf feeds/packages/net/adguardhome
        rm -rf feeds/packages/net/ariang
        rm -rf feeds/packages/net/frp
        rm -rf feeds/packages/lang/golang
        log_success "å†²çªåŒ…ç§»é™¤å®Œæˆ"
        
        # --- ä¿®æ”¹ LuCI ç¼–è¯‘ç½²å ---
        log_info "ä¿®æ”¹ LuCI ç¼–è¯‘ç½²å..."
        luci_status_file="feeds/luci/modules/luci-mod-status/htdocs/luci-static/resources/view/status/include/10_system.js"
        if [ -f "$luci_status_file" ]; then
            sed -i "s/(\(luciversion || ''\))/(\1) + (' \/ Built by Mary')/g" "$luci_status_file"
        fi
        log_success "LuCI ç¼–è¯‘ç½²åä¿®æ”¹å®Œæˆ"

        log_success "diy.sh (å†…è”ç‰ˆæœ¬) æ‰§è¡Œå®Œæˆ"
        
        # Feeds æ›´æ–°ååŒ…åˆ—è¡¨
        log_info "æ›´æ–° feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        grep "^CONFIG_PACKAGE_luci-app-.*=y" "$CONFIG_PATH" | sed 's/CONFIG_PACKAGE_\(.*\)=y/\1/' | sort > feeds_luci.txt
        
        # Defconfig åæœ€ç»ˆåŒ…åˆ—è¡¨
        log_info "è¿è¡Œ make defconfig..."
        make defconfig
        grep "^CONFIG_PACKAGE_luci-app-.*=y" "$CONFIG_PATH" | sed 's/CONFIG_PACKAGE_\(.*\)=y/\1/' | sort > final_luci.txt
        
        # ç”Ÿæˆå·®å¼‚æŠ¥å‘Š
        REPORT_FILE="${{ github.workspace }}/luci_diff_report.md"
        echo "## LuCI è½¯ä»¶åŒ…å·®å¼‚æŠ¥å‘Š" > "$REPORT_FILE"
        echo -e "\næ­¤æŠ¥å‘Šå±•ç¤ºäº†åœ¨ç¼–è¯‘æµç¨‹ä¸­ï¼ŒLuCI åº”ç”¨åŒ…çš„å˜åŒ–æƒ…å†µã€‚\n" >> "$REPORT_FILE"
        
        echo "### 1. Feeds æ›´æ–°åæ–°å¢çš„åŒ…" >> "$REPORT_FILE"
        echo '```' >> "$REPORT_FILE"
        comm -13 initial_luci.txt feeds_luci.txt >> "$REPORT_FILE" || log_warn "Feeds æ›´æ–°åæ— æ–°å¢åŒ…"
        echo '```' >> "$REPORT_FILE"

        echo "### 2. make defconfig åæ–°å¢çš„åŒ…" >> "$REPORT_FILE"
        echo '```' >> "$REPORT_FILE"
        comm -13 feeds_luci.txt final_luci.txt >> "$REPORT_FILE" || log_warn "defconfig åæ— æ–°å¢åŒ…"
        echo '```' >> "$REPORT_FILE"

        echo "### 3. make defconfig åç§»é™¤çš„åŒ…" >> "$REPORT_FILE"
        echo '```' >> "$REPORT_FILE"
        comm -23 feeds_luci.txt final_luci.txt >> "$REPORT_FILE" || log_warn "defconfig åæ— ç§»é™¤åŒ…"
        echo '```' >> "$REPORT_FILE"

        echo "### 4. æœ€ç»ˆ LuCI åŒ…æ¸…å•" >> "$REPORT_FILE"
        echo '```' >> "$REPORT_FILE"
        cat final_luci.txt >> "$REPORT_FILE"
        echo '```' >> "$REPORT_FILE"
        
        log_success "LuCI å·®å¼‚æŠ¥å‘Šå·²ç”Ÿæˆ: luci_diff_report.md"
        echo "REPORT_PATH=$REPORT_FILE" >> $GITHUB_ENV

    - name: ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        # --- æ—¥å¿—å’Œé¢œè‰²å‡½æ•°å®šä¹‰ ---
        export TERM=xterm-256color
        log_info() { echo -e "\033[34m[INFO]\033[0m $1"; }
        log_success() { echo -e "\033[32m[OK]\033[0m $1"; }
        log_warn() { echo -e "\033[33m[WARN]\033[0m $1"; }
        log_error() { echo -e "\033[31m[FAIL]\033[0m $1"; }
        
        cd ${{ env.OPENWRT_PATH }}
        log_info "å¼€å§‹ä¸‹è½½æ‰€æœ‰æºç åŒ…..."
        make download -j$(nproc)
        log_success "æºç åŒ…ä¸‹è½½å®Œæˆ"
        
        log_info "å¼€å§‹ç¼–è¯‘å›ºä»¶ (ä½¿ç”¨ $(nproc) ä¸ªçº¿ç¨‹)..."
        make -j$(nproc) || make -j1 || make -j1 V=s
        log_success "å›ºä»¶ç¼–è¯‘æˆåŠŸ"
        echo "status=success" >> $GITHUB_OUTPUT
        echo "DATE=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV
        echo "FILE_DATE=$(date +"%Y.%m.%d")" >> $GITHUB_ENV

    - name: æ£€æŸ¥ç£ç›˜ä½¿ç”¨æƒ…å†µ
      if: always()
      run: df -hT

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      if: steps.compile.outputs.status == 'success'
      run: |
        # --- æ—¥å¿—å’Œé¢œè‰²å‡½æ•°å®šä¹‰ ---
        export TERM=xterm-256color
        log_info() { echo -e "\033[34m[INFO]\033[0m $1"; }
        log_success() { echo -e "\033[32m[OK]\033[0m $1"; }
        
        log_info "æ•´ç†å’Œé‡å‘½åå›ºä»¶æ–‡ä»¶..."
        cd ${{ env.OPENWRT_PATH }}/bin/targets/*/*
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        RELEASE_DIR="firmware_${{ env.FILE_DATE }}"
        mkdir -p "$RELEASE_DIR"
        
        # å¤åˆ¶é€šç”¨æ–‡ä»¶
        cp ${{ env.OPENWRT_PATH }}/.config "$RELEASE_DIR/immu.config"
        cp config.buildinfo "$RELEASE_DIR/immu.config.buildinfo"
        if [ -f "*.manifest" ]; then
          cp *.manifest "$RELEASE_DIR/"
        fi
        
        # å¾ªç¯å¤„ç†æ¯ä¸ªè®¾å¤‡çš„å›ºä»¶
        for device in ${{ env.DEVICE_LIST }}; do
          log_info "å¤„ç†è®¾å¤‡: $device"
          # æŸ¥æ‰¾å¹¶é‡å‘½åå›ºä»¶
          find . -maxdepth 1 -name "*${device}*" -type f -not -name "*.manifest" -exec cp {} "$RELEASE_DIR/immu_${device}_{}.img" \;
        done
        
        # æ‰“åŒ…æ‰€æœ‰äº§ç‰©
        tar -zcf "${RELEASE_DIR}.tar.gz" "$RELEASE_DIR"
        echo "FIRMWARE_PATH=${{ github.workspace }}/${RELEASE_DIR}.tar.gz" >> $GITHUB_ENV
        log_success "å›ºä»¶æ•´ç†å®Œæˆ: ${RELEASE_DIR}.tar.gz"

    - name: ä¸Šä¼ å›ºä»¶åˆ° Artifacts
      if: steps.compile.outputs.status == 'success' && github.event.inputs.upload_bin_dir == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt_bin_${{ env.FILE_DATE }}
        path: ${{ env.OPENWRT_PATH }}/bin

    - name: ä¸Šä¼ å›ºä»¶åˆ° Release
      if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE == 'true'
      uses: ncipollo/release-action@v1
      with:
        name: ${{ env.DATE }} for ${{ env.FIRMWARE_TAG }}
        allowUpdates: true
        tag: ${{ env.FIRMWARE_TAG }}
        artifacts: ${{ env.FIRMWARE_PATH }}
        body: |
          **è¿™æ˜¯ä¸º ${{ env.FIRMWARE_TAG }} å¹³å°ç¼–è¯‘çš„ ImmortalWrt å›ºä»¶**
          
          ### ğŸ“’ å›ºä»¶ä¿¡æ¯
          - ğŸ’» è¿™æ˜¯ ${{ env.FIRMWARE_TAG }} å¹³å°ä½¿ç”¨çš„ OpenWrt å›ºä»¶
          - âš½ å›ºä»¶æºç : ${{ env.REPO_URL }}
          - ğŸ’ æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}
          - ğŸŒ é»˜è®¤åœ°å€: **192.168.111.1**
          - ğŸ”‘ é»˜è®¤å¯†ç : **ç©º**
          
          ### ğŸ§Š å›ºä»¶ç‰ˆæœ¬
          - å›ºä»¶ç¼–è¯‘å‰æœ€åä¸€æ¬¡â¦[ä¸»æºç ](${{ env.REPO_URL }})æ›´æ–°è®°å½•
          - ${{ env.VERSION_INFO }}
          
          ### ğŸ“¦ åŒ…å«è®¾å¤‡
          - ${{ env.DEVICE_LIST }}
          
          ---
          
          ${{ steps.config.outputs.REPORT_PATH }}
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: æ¸…ç†æ—§ç¼“å­˜
      if: always()
      run: |
        # å®‰è£… gh cli
        sudo apt-get update && sudo apt-get install -y gh
        # è·å–å¹¶åˆ é™¤æ—§ç¼“å­˜
        gh cache list --key ${{ env.REPO_BRANCH }}-${{ hashFiles('configs/immu.config') }}- --json key --jq '.[] | .key' | while read -r key; do
          gh cache delete "$key"
        done
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
