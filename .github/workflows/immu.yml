# ==============================================================================
# ImmortalWrt è‡ªåŠ¨åŒ–ç¼–è¯‘å·¥ä½œæµ
#
# åŠŸèƒ½:
#   1. è‡ªåŠ¨åŒ–ç¼–è¯‘ ImmortalWrt å›ºä»¶ï¼Œæ”¯æŒå¤šè®¾å¤‡
#   2. é›†æˆç£ç›˜ç©ºé—´æ‰©å±•ã€é«˜çº§ç¼“å­˜ç­–ç•¥
#   3. ç”Ÿæˆ LuCI è½¯ä»¶åŒ…å·®å¼‚æŠ¥å‘Šå’Œè®¾å¤‡æ¸…å•
#   4. æä¾›ä¼ä¸šçº§çš„æ—¥å¿—ã€é”™è¯¯æ§åˆ¶å’Œå‘å¸ƒç³»ç»Ÿ
#
# è§¦å‘æ–¹å¼:
#   - æ‰‹åŠ¨è§¦å‘
#   - å®šæ—¶è§¦å‘ (å·²æ³¨é‡Šï¼Œå¯æŒ‰éœ€å¯ç”¨)
#
# ä½œè€…: Mary
# æ—¥æœŸï¼š20251201
# ç‰ˆæœ¬: 2.1 - ä¿®å¤ç¼“å­˜é¡ºåºå’Œå‡½æ•°ä½œç”¨åŸŸé—®é¢˜
# ==============================================================================

name: ImmortalWrt è‡ªåŠ¨ç¼–è¯‘ç³»ç»Ÿ

on:
  workflow_dispatch:
    inputs:
      upload_bin_dir:
        description: 'æ˜¯å¦ä¸Šä¼ æ•´ä¸ª bin ç›®å½• (è°ƒè¯•ç”¨)'
        required: false
        default: 'false'
        type: boolean
  # schedule:
  #   - cron: 0 20 * * 4 # æ¯å‘¨å›› UTC 20:00 è‡ªåŠ¨ç¼–è¯‘

env:
  REPO_URL: https://github.com/laipeng668/immortalwrt.git
  REPO_BRANCH: master
  CONFIG_FILE: configs/immu.config
  DIY_SCRIPT: scripts/diy.sh
  EXTEND_DISK_SCRIPT: scripts/extend_disk.sh
  FIRMWARE_RELEASE: true
  FIRMWARE_TAG: immu
  TZ: Asia/Shanghai

jobs:
  Build:
    runs-on: ubuntu-24.04

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
      run: |
        # --- æ—¥å¿—å’Œé¢œè‰²å‡½æ•°å®šä¹‰ ---
        export TERM=xterm-256color
        log_info() { echo -e "\033[34m[INFO]\033[0m $1"; }
        log_success() { echo -e "\033[32m[OK]\033[0m $1"; }
        log_warn() { echo -e "\033[33m[WARN]\033[0m $1"; }
        log_error() { echo -e "\033[31m[FAIL]\033[0m $1"; }

        log_info "åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ..."
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL https://fastly.jsdelivr.net/gh/ophub/amlogic-s9xxx-openwrt@main/ubuntu2404-make-openwrt-depends)
        sudo -E systemctl daemon-reload
        sudo timedatectl set-timezone "$TZ"
        log_success "ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

    - name: æ£€å‡ºæºç 
      id: checkout
      run: |
        # --- æ—¥å¿—å’Œé¢œè‰²å‡½æ•°å®šä¹‰ ---
        export TERM=xterm-256color
        log_info() { echo -e "\033[34m[INFO]\033[0m $1"; }
        log_success() { echo -e "\033[32m[OK]\033[0m $1"; }
        log_warn() { echo -e "\033[33m[WARN]\033[0m $1"; }
        log_error() { echo -e "\033[31m[FAIL]\033[0m $1"; }

        log_info "æ£€å‡º ImmortalWrt æºç ..."
        df -hT $GITHUB_WORKSPACE
        sudo mkdir -p /mnt/openwrt
        sudo chown -R $(id -u):$(id -g) /mnt/openwrt
        git clone --depth 1 -b $REPO_BRANCH --single-branch $REPO_URL /mnt/openwrt
        cd /mnt/openwrt
        
        # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "OPENWRT_PATH=/mnt/openwrt" >> $GITHUB_ENV
        VERSION_INFO=$(git show -s --date=short --format="ä½œè€…: %an<br/>æ—¶é—´: %cd<br/>å†…å®¹: %s<br/>Hash: %H")
        echo "VERSION_INFO=$VERSION_INFO" >> $GITHUB_ENV
        echo "CACHE_DATE=$(date +"%Y-%m-%d-%H%M%S")" >> $GITHUB_ENV
        log_success "æºç æ£€å‡ºå®Œæˆ"

    - name: æ‰©å±•ç£ç›˜ç©ºé—´ (å…³é”®æ­¥éª¤)
      run: |
        # --- æ—¥å¿—å’Œé¢œè‰²å‡½æ•°å®šä¹‰ ---
        export TERM=xterm-256color
        log_info() { echo -e "\033[34m[INFO]\033[0m $1"; }
        log_success() { echo -e "\033[32m[OK]\033[0m $1"; }
        log_warn() { echo -e "\033[33m[WARN]\033[0m $1"; }
        log_error() { echo -e "\033[31m[FAIL]\033[0m $1"; }

        log_info "å‡†å¤‡æ‰©å±•ç£ç›˜ç©ºé—´..."
        if [ -f "${{ github.workspace }}/${{ env.EXTEND_DISK_SCRIPT }}" ]; then
          chmod +x "${{ github.workspace }}/${{ env.EXTEND_DISK_SCRIPT }}"
          # åœ¨æºç ç›®å½•å†…æ‰§è¡Œï¼Œå› ä¸ºè„šæœ¬ä¼šå¤„ç†å½“å‰ç›®å½•ä¸‹çš„å­ç›®å½•
          cd ${{ env.OPENWRT_PATH }}
          ${{ github.workspace }}/${{ env.EXTEND_DISK_SCRIPT }} .
          log_success "ç£ç›˜ç©ºé—´æ‰©å±•å®Œæˆ"
        else
          log_warn "æœªæ‰¾åˆ°ç£ç›˜æ‰©å±•è„šæœ¬ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
        fi

    - name: ç¼“å­˜å·¥å…·é“¾å’Œä¸‹è½½ç›®å½• (å…³é”®æ­¥éª¤)
      uses: actions/cache@v4
      with:
        path: |
          ${{ env.OPENWRT_PATH }}/.ccache
          ${{ env.OPENWRT_PATH }}/dl
          ${{ env.OPENWRT_PATH }}/staging_dir
        key: ${{ env.REPO_BRANCH }}-${{ hashFiles('configs/immu.config') }}-${{ env.CACHE_DATE }}
        restore-keys: |
          ${{ env.REPO_BRANCH }}-${{ hashFiles('configs/immu.config') }}-

    - name: åŠ è½½è‡ªå®šä¹‰é…ç½®ä¸ç”ŸæˆæŠ¥å‘Š
      id: config
      run: |
        # --- æ—¥å¿—å’Œé¢œè‰²å‡½æ•°å®šä¹‰ ---
        export TERM=xterm-256color
        log_info() { echo -e "\033[34m[INFO]\033[0m $1"; }
        log_success() { echo -e "\033[32m[OK]\033[0m $1"; }
        log_warn() { echo -e "\033[33m[WARN]\033[0m $1"; }
        log_error() { echo -e "\033[31m[FAIL]\033[0m $1"; }
        
        cd ${{ env.OPENWRT_PATH }}
        CONFIG_PATH="${{ github.workspace }}/${{ env.CONFIG_FILE }}"
        
        # 1. æå–è®¾å¤‡åç§°
        log_info "ä»é…ç½®æ–‡ä»¶ä¸­æå–ç›®æ ‡è®¾å¤‡..."
        DEVICES=$(grep "^CONFIG_TARGET_DEVICE_.*_DEVICE_.*=y" "$CONFIG_PATH" | sed 's/^CONFIG_TARGET_DEVICE_.*_DEVICE_\(.*\)=y/\1/' | sort -u | tr '\n' ' ')
        echo "DEVICE_LIST=$DEVICES" >> $GITHUB_ENV
        log_success "æå–åˆ°è®¾å¤‡: $DEVICES"

        # 2. ç”Ÿæˆ LuCI åŒ…å·®å¼‚æŠ¥å‘Š
        log_info "å‡†å¤‡ç”Ÿæˆ LuCI åŒ…å·®å¼‚æŠ¥å‘Š..."
        
        # åˆå§‹åŒ…åˆ—è¡¨
        grep "^CONFIG_PACKAGE_luci-app-.*=y" "$CONFIG_PATH" | sed 's/CONFIG_PACKAGE_\(.*\)=y/\1/' | sort > initial_luci.txt
        
        # æ‰§è¡Œ diy.sh
        log_info "æ‰§è¡Œ diy.sh å‡†å¤‡è½¯ä»¶æº..."
        chmod +x "${{ github.workspace }}/${{ env.DIY_SCRIPT }}"
        "${{ github.workspace }}/${{ env.DIY_SCRIPT }}"
        
        # Feeds æ›´æ–°ååŒ…åˆ—è¡¨
        log_info "æ›´æ–° feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        grep "^CONFIG_PACKAGE_luci-app-.*=y" "$CONFIG_PATH" | sed 's/CONFIG_PACKAGE_\(.*\)=y/\1/' | sort > feeds_luci.txt
        
        # Defconfig åæœ€ç»ˆåŒ…åˆ—è¡¨
        log_info "è¿è¡Œ make defconfig..."
        make defconfig
        grep "^CONFIG_PACKAGE_luci-app-.*=y" "$CONFIG_PATH" | sed 's/CONFIG_PACKAGE_\(.*\)=y/\1/' | sort > final_luci.txt
        
        # ç”Ÿæˆå·®å¼‚æŠ¥å‘Š
        REPORT_FILE="${{ github.workspace }}/luci_diff_report.md"
        echo "## LuCI è½¯ä»¶åŒ…å·®å¼‚æŠ¥å‘Š" > "$REPORT_FILE"
        echo -e "\næ­¤æŠ¥å‘Šå±•ç¤ºäº†åœ¨ç¼–è¯‘æµç¨‹ä¸­ï¼ŒLuCI åº”ç”¨åŒ…çš„å˜åŒ–æƒ…å†µã€‚\n" >> "$REPORT_FILE"
        
        echo "### 1. Feeds æ›´æ–°åæ–°å¢çš„åŒ…" >> "$REPORT_FILE"
        echo '```' >> "$REPORT_FILE"
        comm -13 initial_luci.txt feeds_luci.txt >> "$REPORT_FILE" || log_warn "Feeds æ›´æ–°åæ— æ–°å¢åŒ…"
        echo '```' >> "$REPORT_FILE"

        echo "### 2. make defconfig åæ–°å¢çš„åŒ…" >> "$REPORT_FILE"
        echo '```' >> "$REPORT_FILE"
        comm -13 feeds_luci.txt final_luci.txt >> "$REPORT_FILE" || log_warn "defconfig åæ— æ–°å¢åŒ…"
        echo '```' >> "$REPORT_FILE"

        echo "### 3. make defconfig åç§»é™¤çš„åŒ…" >> "$REPORT_FILE"
        echo '```' >> "$REPORT_FILE"
        comm -23 feeds_luci.txt final_luci.txt >> "$REPORT_FILE" || log_warn "defconfig åæ— ç§»é™¤åŒ…"
        echo '```' >> "$REPORT_FILE"

        echo "### 4. æœ€ç»ˆ LuCI åŒ…æ¸…å•" >> "$REPORT_FILE"
        echo '```' >> "$REPORT_FILE"
        cat final_luci.txt >> "$REPORT_FILE"
        echo '```' >> "$REPORT_FILE"
        
        log_success "LuCI å·®å¼‚æŠ¥å‘Šå·²ç”Ÿæˆ: luci_diff_report.md"
        echo "REPORT_PATH=$REPORT_FILE" >> $GITHUB_ENV

    - name: ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        # --- æ—¥å¿—å’Œé¢œè‰²å‡½æ•°å®šä¹‰ ---
        export TERM=xterm-256color
        log_info() { echo -e "\033[34m[INFO]\033[0m $1"; }
        log_success() { echo -e "\033[32m[OK]\033[0m $1"; }
        log_warn() { echo -e "\033[33m[WARN]\033[0m $1"; }
        log_error() { echo -e "\033[31m[FAIL]\033[0m $1"; }
        
        cd ${{ env.OPENWRT_PATH }}
        log_info "å¼€å§‹ä¸‹è½½æ‰€æœ‰æºç åŒ…..."
        make download -j$(nproc)
        log_success "æºç åŒ…ä¸‹è½½å®Œæˆ"
        
        log_info "å¼€å§‹ç¼–è¯‘å›ºä»¶ (ä½¿ç”¨ $(nproc) ä¸ªçº¿ç¨‹)..."
        make -j$(nproc) || make -j1 || make -j1 V=s
        log_success "å›ºä»¶ç¼–è¯‘æˆåŠŸ"
        echo "status=success" >> $GITHUB_OUTPUT
        echo "DATE=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV
        echo "FILE_DATE=$(date +"%Y.%m.%d")" >> $GITHUB_ENV

    - name: æ£€æŸ¥ç£ç›˜ä½¿ç”¨æƒ…å†µ
      if: always()
      run: df -hT

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      if: steps.compile.outputs.status == 'success'
      run: |
        # --- æ—¥å¿—å’Œé¢œè‰²å‡½æ•°å®šä¹‰ ---
        export TERM=xterm-256color
        log_info() { echo -e "\033[34m[INFO]\033[0m $1"; }
        log_success() { echo -e "\033[32m[OK]\033[0m $1"; }
        
        log_info "æ•´ç†å’Œé‡å‘½åå›ºä»¶æ–‡ä»¶..."
        cd ${{ env.OPENWRT_PATH }}/bin/targets/*/*
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        RELEASE_DIR="firmware_${{ env.FILE_DATE }}"
        mkdir -p "$RELEASE_DIR"
        
        # å¤åˆ¶é€šç”¨æ–‡ä»¶
        cp ${{ env.OPENWRT_PATH }}/.config "$RELEASE_DIR/immu.config"
        cp config.buildinfo "$RELEASE_DIR/immu.config.buildinfo"
        if [ -f "*.manifest" ]; then
          cp *.manifest "$RELEASE_DIR/"
        fi
        
        # å¾ªç¯å¤„ç†æ¯ä¸ªè®¾å¤‡çš„å›ºä»¶
        for device in ${{ env.DEVICE_LIST }}; do
          log_info "å¤„ç†è®¾å¤‡: $device"
          # æŸ¥æ‰¾å¹¶é‡å‘½åå›ºä»¶
          find . -maxdepth 1 -name "*${device}*" -type f -not -name "*.manifest" -exec cp {} "$RELEASE_DIR/immu_${device}_{}.img" \;
        done
        
        # æ‰“åŒ…æ‰€æœ‰äº§ç‰©
        tar -zcf "${RELEASE_DIR}.tar.gz" "$RELEASE_DIR"
        echo "FIRMWARE_PATH=${{ github.workspace }}/${RELEASE_DIR}.tar.gz" >> $GITHUB_ENV
        log_success "å›ºä»¶æ•´ç†å®Œæˆ: ${RELEASE_DIR}.tar.gz"

    - name: ä¸Šä¼ å›ºä»¶åˆ° Artifacts
      if: steps.compile.outputs.status == 'success' && github.event.inputs.upload_bin_dir == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt_bin_${{ env.FILE_DATE }}
        path: ${{ env.OPENWRT_PATH }}/bin

    - name: ä¸Šä¼ å›ºä»¶åˆ° Release
      if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE == 'true'
      uses: ncipollo/release-action@v1
      with:
        name: ${{ env.DATE }} for ${{ env.FIRMWARE_TAG }}
        allowUpdates: true
        tag: ${{ env.FIRMWARE_TAG }}
        artifacts: ${{ env.FIRMWARE_PATH }}
        body: |
          **è¿™æ˜¯ä¸º ${{ env.FIRMWARE_TAG }} å¹³å°ç¼–è¯‘çš„ ImmortalWrt å›ºä»¶**
          
          ### ğŸ“’ å›ºä»¶ä¿¡æ¯
          - ğŸ’» è¿™æ˜¯ ${{ env.FIRMWARE_TAG }} å¹³å°ä½¿ç”¨çš„ OpenWrt å›ºä»¶
          - âš½ å›ºä»¶æºç : ${{ env.REPO_URL }}
          - ğŸ’ æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}
          - ğŸŒ é»˜è®¤åœ°å€: **192.168.111.1**
          - ğŸ”‘ é»˜è®¤å¯†ç : none
          
          ### ğŸ§Š å›ºä»¶ç‰ˆæœ¬
          - å›ºä»¶ç¼–è¯‘å‰æœ€åä¸€æ¬¡â¦[ä¸»æºç ](${{ env.REPO_URL }})æ›´æ–°è®°å½•
          - ${{ env.VERSION_INFO }}
          
          ### ğŸ“¦ åŒ…å«è®¾å¤‡
          - ${{ env.DEVICE_LIST }}
          
          ---
          
          ${{ steps.config.outputs.REPORT_PATH }}
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: æ¸…ç†æ—§ç¼“å­˜
      if: always()
      run: |
        # å®‰è£… gh cli
        sudo apt-get update && sudo apt-get install -y gh
        # è·å–å¹¶åˆ é™¤æ—§ç¼“å­˜
        gh cache list --key ${{ env.REPO_BRANCH }}-${{ hashFiles('configs/immu.config') }}- --json key --jq '.[] | .key' | while read -r key; do
          gh cache delete "$key"
        done
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
